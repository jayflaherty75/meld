#!/bin/bash

compileExternal () {
	fbc -mt -s console -dylib -export "./src/fb/$3/$2/$1/$1.bas" -x "modules/$1.so" \
		|| { echo; echo Failed to compile $1 module, build terminated; exit 1; }
}

cat "./src/fb/${3:-shared}/${2:-lib}/$1/$1.bas" | ./build/parse-fb $1 > ./modules/definitions/$1.xml
./build/header $1

xsltproc -o ./src/fb/${3:-shared}/${2:-lib}/$1/module.bi ./build/templates/module-fb.xslt ./modules/definitions/$1.xml

xsltproc -o ./src/fb/${3:-shared}/${2:-lib}/$1/$1.bi ./build/templates/include-fb.xslt ./modules/definitions/$1.xml

compileExternal $1 ${2:-lib} ${3:-shared}
