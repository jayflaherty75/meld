#!/bin/bash

MELD_DIR=$1
MODULE_NAME=$2
MODULE_VERSION=$(<./.meld/version)
SEP="_v"

compileExternal () {
	fbc -mt -s console -dylib -export "./src/$1.bas" -x "./bin/module.so" \
		|| { echo; echo Failed to compile $1 module, build terminated; exit 1; }
}

if [ -f "./bin/module.xml" ]; then
	rm ./bin/module.xml
fi

if [ -f "./.meld/deps" ]; then
	rm ./.meld/deps
fi

cat "./src/$MODULE_NAME.bas" | $MELD_DIR/build/parse-fb $MODULE_NAME > ./bin/module.xml

xsltproc -o ./.meld/version "$MELD_DIR/build/templates/version.xslt" ./bin/module.xml

xsltproc -o ./.meld/deps "$MELD_DIR/build/templates/dependencies.xslt" ./bin/module.xml

if [ -f "./.meld/deps" ]; then
	MODULE_DEPS=$(<./.meld/deps)

	while read -r REQUIRE; do
		RESOLVED=`$MELD_DIR/build/resolve-version $REQUIRE`
		xsltproc -o ./src/headers/$RESOLVED.bi "$MELD_DIR/build/templates/header-fb.xslt" "./meld_modules/$RESOLVED/module.xml"
	done <<< "$MODULE_DEPS"
fi

xsltproc -o ./src/headers/meld_v0.1.0.bi "$MELD_DIR/build/templates/header-fb.xslt" "./meld_modules/meld_v0.1.0/module.xml"
xsltproc -o ./src/headers/module_v0.1.0.bi "$MELD_DIR/build/templates/header-fb.xslt" "./meld_modules/module_v0.1.0/module.xml"

xsltproc -o ./src/headers/$MODULE_NAME$SEP$MODULE_VERSION.bi "$MELD_DIR/build/templates/header-fb.xslt" ./bin/module.xml

xsltproc -o ./src/module.bi "$MELD_DIR/build/templates/module-fb.xslt" ./bin/module.xml

xsltproc -o ./src/$MODULE_NAME.bi "$MELD_DIR/build/templates/include-fb.xslt" ./bin/module.xml

compileExternal $MODULE_NAME
